# M5Atom Socket with LINE Messaging API
M5Atom Socketを使用したスマートコンセントのプロジェクトです。電源のON/OFF制御、消費電力モニタリング、LINE通知、およびAmbientへのデータ送信機能を備えています。

## 主な機能

- **遠隔制御**: Webベースのインターフェースによる電源ON/OFF制御
- **リアルタイム監視**: 電圧、電流、電力、力率のリアルタイム測定
- **スマート自動OFF**: 消費電力が閾値を下回った際の自動電源切断機能
- **LINE通知**: 電力状態変化の即座なLINE Messaging API通知
- **Ambient連携**: 設定可能なチャンネルでのクラウドデータロギング（オプション）
- **モダンWeb UI**: レスポンシブでモバイル対応のリアルタイム更新インターフェース
- **WiFi管理**: 簡単なネットワーク設定のためのWiFiManager内蔵
- **OTAアップデート**: Webインターフェースによる無線ファームウェア更新
- **設定の永続化**: NVSストレージによる設定の保持
- **ハードウェア制御**: 物理ボタン制御とLEDステータス表示

## ハードウェア要件

- M5Atom
- M5Atom Socket
- Wi-Fi接続環境

## ソフトウェア要件

- Arduino IDE
- 以下のライブラリ:
  - M5Atom
  - ElegantOTA
  - ESP32_LINE_Messaging_API
  - WiFiManager
  - WiFiClientSecure
  - Ambient (オプション)

## インストール手順

1. リポジトリをクローンするか、ソースコードをダウンロードします
2. Arduino IDEで `M5Atom_Socket_LineAPI_Ambient.ino` を開きます
3. 必要なライブラリをインストールします
4. 設定をカスタマイズします（後述）
5. M5Atomにスケッチをアップロードします

## 設定

### APIキーの管理

#### 確認方法

1. ブラウザで `http://[デバイスのIPアドレス]/apikey` にアクセス
2. 現在保存されているAPIキーが表示されます

#### クリア方法

1. ブラウザで `http://[デバイスのIPアドレス]/clearapikey` にアクセス
2. デバイスが自動的に再起動します
3. 再起動後、新しいAPIキーを設定してください

### 必須設定

デバイスはWebベースの設定システムを使用します。Webインターフェースから設定にアクセスしてください：

1. **Web設定インターフェース**: `http://[デバイスIP]/settings` で設定画面にアクセス
2. **LINE APIキー管理**: `http://[デバイスIP]/apikey` でLINEアクセストークンを管理
3. **デバイス設定**: すべての設定がWebインターフェースから変更可能：
   - デバイス名のカスタマイズ
   - 電流閾値（デフォルト: 0.3A）
   - 自動OFF時間（デフォルト: 60分）
   - Ambient連携設定
   - 自動OFF機能の有効/無効

### 詳細設定

- **Ambient設定**: WebインターフェースからチャンネルIDとライトキーで有効/無効を設定
- **デバッグモード**: ソースコード内で設定可能（`#define debug true`）
- **電力閾値**: 自動OFF機能の電流閾値を調整可能
- **タイミング設定**: 自動OFF時間と監視間隔をカスタマイズ可能

## 使用方法

### 初期セットアップ
1. M5Atom Socketの電源を入れます
2. Wi-Fi接続に失敗した場合、WiFiManagerが"ATOM-SOCKET-[MAC]"という名前のAPを作成します
3. APに接続し、`192.168.4.1`にアクセスしてWi-Fi認証情報を設定し、LINEのAPI Keyを入力します
4. デバイスが再起動し、Wi-Fiネットワークに接続します
5. デバイスのIPアドレスがLINE通知で送信されます

### Webインターフェース機能
- **メインダッシュボード**: モダンUIでのリアルタイム電力監視
- **電源制御**: 即座のフィードバック付きソケットON/OFF切り替え
- **設定ページ**: 包括的な設定インターフェース
- **APIキー管理**: 安全なLINEトークン設定
- **ステータス監視**: 電圧、電流、電力、力率のライブ表示

### 物理制御
- **ボタン操作**: 電源のON/OFF切り替え
- **LEDインジケータ**: 視覚的なステータスフィードバック
- **自動OFF**: 負荷が閾値を下回った際の自動電源切断

## OTAアップデート

1. Webブラウザで `http://[デバイスのIPアドレス]/update` にアクセス
2. 認証情報を入力（デフォルト: ユーザー名 `admin`、パスワード `admin`）
3. ArduinoIDEで生成した新しいファームウェア（.binファイル）をアップロード

### OTAアップデート時の注意

- パーティションスキームは「Default」を選択してください

## トラブルシューティング

### OTAアップデートに失敗する場合

1. パーティションスキームが「Default」に設定されていることを確認
2. 安定したWi-Fi接続を確保

### LINE通知が届かない場合

1. アクセストークンが正しく設定されているか確認
2. インターネット接続を確認
3. LINE Messaging APIの制限に達していないか確認
4. 長いAPIキーが正しく保存されない場合、デバイスを再起動して再度設定を試してください

### LINE APIキーが正しく保存されない場合

- 問題: 長いLINE APIキー（約170文字）が正しく保存されない
- 解決策: 最新バージョンではバッファサイズを200文字に拡張して対応
  - バージョン1.1.0以降で修正済み
  - 古いバージョンをご利用の場合は、最新版にアップデートしてください

## ライセンス

このプロジェクトはオープンソースです。詳細はLICENSEファイルを参照してください。

## 参照

- [M5Stack公式サイト](https://m5stack.com/)
- [LINE Messaging API](https://developers.line.biz/ja/services/messaging-api/)
- [Ambient](https://ambidata.io/)
