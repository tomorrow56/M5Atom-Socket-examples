# M5Atom Socket with LINE Messaging API
A smart socket project using M5Atom Socket. Features power ON/OFF control, power consumption monitoring, LINE notifications, and data transmission to Ambient.

## Key Features

- Remote control via web interface
- Real-time power consumption monitoring (voltage, current, power)
- LINE Messaging API notifications when power consumption falls below set threshold
- Data transmission to Ambient (optional)
- OTA (Over-The-Air) update support

## Hardware Requirements

- M5Atom
- M5Atom Socket
- Wi-Fi connection

## Software Requirements

- Arduino IDE
- Required libraries:
  - M5Atom
  - ElegantOTA
  - ESP32LineMessenger
  - WiFiManager
  - WiFiClientSecure
  - Ambient (optional)

## Installation

1. Clone the repository or download the source code
2. Open `M5Atom_Socket_LineAPI_Ambient.ino` in Arduino IDE
3. Install the required libraries
4. Customize the settings (see below)
5. Upload the sketch to your M5Atom

## Configuration

### API Key Management

#### How to Check Current API Key

1. Access `http://[device-ip-address]/apikey` in your browser
2. The currently saved API key will be displayed

#### How to Clear API Key

1. Access `http://[device-ip-address]/clearapikey` in your browser
2. The device will automatically restart
3. After restart, set a new API key

### Required Settings

Open `M5Atom_Socket_LineAPI_Ambient.ino` and configure the following settings:

```cpp
// Device name
#define DEVICE_NAME "M5Atom Socket"  // Change to your preferred device name

// LINE Notify Access Token
const char* accessToken = "<YOUR_LINE_NOTIFY_TOKEN>";  // Replace with your actual token
```

### Optional Settings

- To use Ambient, uncomment `useAmb` and set your channel ID and write key
- Toggle debug mode by modifying the `debug` variable

## Usage

1. Power on the M5Atom to connect to Wi-Fi
2. If Wi-Fi connection fails, the WiFiManager will start. Connect to the "ATOM-SOCKET-" AP and access "192.168.4.1" in your browser to enter your Wi-Fi credentials
3. Access the device's IP address shown in the serial monitor
4. Web interface allows you to:
   - Toggle power ON/OFF
   - Check power consumption
   - View device information

## OTA Update

1. Access `http://[device-ip-address]/update` in your browser
2. Enter credentials (default: username `admin`, password `admin`)
3. Upload the new firmware (.bin file) generated by Arduino IDE

### OTA Update Notes

- Select "Default" for the partition scheme

## Troubleshooting

### If OTA Update Fails

1. Verify the partition scheme is set to "Default"
2. Ensure a stable Wi-Fi connection

### If LINE Notifications Don't Arrive

1. Verify the access token is correctly set
2. Check your internet connection
3. Verify you haven't reached the LINE Messaging API limit
4. If long API keys aren't saving correctly, try restarting the device and reconfiguring

### If LINE API Key Doesn't Save Correctly

- Issue: Long LINE API keys (about 170 characters) don't save properly
- Solution: Buffer size has been increased to 200 characters in the latest version
  - Fixed in version 1.1.0 and later
  - If using an older version, please update to the latest version

## License

This project is open source. See the LICENSE file for details.

## References

- [M5Stack Official Site](https://m5stack.com/)
- [LINE Messaging API](https://developers.line.biz/en/services/messaging-api/)
- [Ambient](https://ambidata.io/)
