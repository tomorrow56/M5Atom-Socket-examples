# M5Atom Socket with LINE Messaging API
A smart socket project using M5Atom Socket. Features power ON/OFF control, power consumption monitoring, LINE notifications, and data transmission to Ambient.

## Key Features

- **Remote Control**: Web-based interface for power ON/OFF control
- **Real-time Monitoring**: Voltage, current, power, and power factor measurement
- **Smart Auto-OFF**: Configurable automatic power cutoff when consumption drops below threshold
- **LINE Notifications**: Instant alerts via LINE Messaging API for power status changes
- **Ambient Integration**: Optional cloud data logging with configurable channel settings
- **Modern Web UI**: Responsive, mobile-friendly interface with real-time updates
- **WiFi Management**: Built-in WiFiManager for easy network configuration
- **OTA Updates**: Over-the-air firmware updates with web interface
- **Persistent Settings**: NVS storage for configuration persistence
- **Hardware Control**: Physical button control with LED status indicators

## Hardware Requirements

- M5Atom
- M5Atom Socket
- Wi-Fi connection

## Software Requirements

- Arduino IDE
- Required libraries:
  - M5Atom
  - ElegantOTA
  - ESP32LineMessenger
  - WiFiManager
  - WiFiClientSecure
  - Ambient (optional)

## Installation

1. Clone the repository or download the source code
2. Open `M5Atom_Socket_LineAPI_Ambient.ino` in Arduino IDE
3. Install the required libraries
4. Customize the settings (see below)
5. Upload the sketch to your M5Atom

## Configuration

### API Key Management

#### How to Check Current API Key

1. Access `http://[device-ip-address]/apikey` in your browser
2. The currently saved API key will be displayed

#### How to Clear API Key

1. Access `http://[device-ip-address]/clearapikey` in your browser
2. The device will automatically restart
3. After restart, set a new API key

### Required Settings

The device uses a web-based configuration system. Access the settings via the web interface:

1. **Web Settings Interface**: Access `http://[device-ip]/settings` for configuration
2. **LINE API Key Management**: Use `http://[device-ip]/apikey` to manage LINE access tokens
3. **Device Configuration**: All settings are configurable via web interface:
   - Device name customization
   - Current threshold (default: 0.3A)
   - Auto-off duration (default: 60 minutes)
   - Ambient integration settings
   - Auto-off feature enable/disable

### Advanced Configuration

- **Ambient Settings**: Enable/disable via web interface with channel ID and write key
- **Debug Mode**: Configurable in source code (`#define debug true`)
- **Power Thresholds**: Adjustable current threshold for auto-off functionality
- **Timing Settings**: Customizable auto-off duration and monitoring intervals

## Usage

### Initial Setup
1. Power on the M5Atom Socket
2. If Wi-Fi connection fails, WiFiManager creates an AP named "ATOM-SOCKET-[MAC]"
3. Connect to the AP and access `192.168.4.1` to configure Wi-Fi credentials and enter LINE API Key
4. Device will restart and connect to your Wi-Fi network
5. LINE notification will be sent with the device's IP address

### Web Interface Features
- **Main Dashboard**: Real-time power monitoring with modern UI
- **Power Control**: Toggle socket ON/OFF with immediate feedback
- **Settings Page**: Comprehensive configuration interface
- **API Key Management**: Secure LINE token configuration
- **Status Monitoring**: Live voltage, current, power, and power factor display

### Physical Controls
- **Button Press**: Toggle power ON/OFF
- **LED Indicators**: Visual status feedback
- **Auto-OFF**: Automatic power cutoff when load drops below threshold

## OTA Update

1. Access `http://[device-ip-address]/update` in your browser
2. Enter credentials (default: username `admin`, password `admin`)
3. Upload the new firmware (.bin file) generated by Arduino IDE

### OTA Update Notes

- Select "Default" for the partition scheme

## Troubleshooting

### If OTA Update Fails

1. Verify the partition scheme is set to "Default"
2. Ensure a stable Wi-Fi connection

### If LINE Notifications Don't Arrive

1. Verify the access token is correctly set
2. Check your internet connection
3. Verify you haven't reached the LINE Messaging API limit
4. If long API keys aren't saving correctly, try restarting the device and reconfiguring

### If LINE API Key Doesn't Save Correctly

- Issue: Long LINE API keys (about 170 characters) don't save properly
- Solution: Buffer size has been increased to 200 characters in the latest version
  - Fixed in version 1.1.0 and later
  - If using an older version, please update to the latest version

## License

This project is open source. See the LICENSE file for details.

## References

- [M5Stack Official Site](https://m5stack.com/)
- [LINE Messaging API](https://developers.line.biz/en/services/messaging-api/)
- [Ambient](https://ambidata.io/)
