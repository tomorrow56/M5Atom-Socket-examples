# M5Atom Socket with LINE Messaging API
This is a smart plug project using the M5Atom Socket. It features power ON/OFF control, power consumption monitoring, LINE notifications, and data transmission to Ambient.

## Main Features

- **Power Control:**
  - Remote ON/OFF via Web UI
  - ON/OFF via the physical button (short press)
- **Power Monitoring:**
  - Real-time display of voltage, current, and power on the Web UI
- **Notification Features:**
  - Sends IP address to LINE on startup
  - Sends a completion notification to LINE when power consumption drops below a threshold (intended for uses like 3D printers)
- **WiFi Configuration:**
  - Automatically starts a configuration access point on first boot
  - Enter WiFi configuration mode anytime by long-pressing the physical button (5+ seconds)
- **Data Transmission:**
  - Data transmission to Ambient (optional)
- **Firmware Update:**
  - Update from the Web UI via OTA (Over-The-Air)

## Hardware Requirements

- M5Atom
- M5Atom Socket
- Wi-Fi connection environment

## Software Requirements

- Arduino IDE
- The following libraries:
  - M5Atom
  - ElegantOTA
  - ESP32LineMessenger
  - WiFiManager
  - WiFiClientSecure
  - Ambient (optional)

## Installation

1. Clone the repository or download the source code.
2. Open `M5Atom_Socket_LineMessagingAPI.ino` in the Arduino IDE.
3. Install the required libraries.
4. Customize the settings (see below).
5. Upload the sketch to the M5Atom.

## Configuration

### Required Configuration

Open `M5Atom_Socket_LineMessagingAPI.ino` and configure the following:

```cpp
// Device Name
#define DEVICE_NAME "Fraxinus"  // Can be changed to any device name

// LINE Messaging API Access Token
const char* accessToken = "<YOUR_LINE_MESSAGING_API_CHANNEL_ACCESS_TOKEN>";  // Replace with your actual token
```

### Optional Configuration

- **Data Transmission to Ambient:**
  - Enable the feature by uncommenting `//#define useAmb` at the beginning of `M5Atom_Socket_LineMessagingAPI.ino`.
  - Set your own `channelId` and `writeKey`.
    ```cpp
    #ifdef useAmb
      #include <Ambient.h>
      Ambient ambient;
      unsigned int channelId = 40780; // Your Ambient channel ID
      const char* writeKey = "<YOUR_Ambient_WRITE_KEY>"; // Your Ambient write key
    #endif
    ```
- **Debug Mode:**
  - Change the value of `debug` to `true` or `false` to enable/disable debug output to the serial console.

## Usage

### 1. WiFi Setup (First time or when changing networks)
- When powered on, the M5Atom will attempt to connect to the saved WiFi network.
- If it cannot connect, or if the physical button is long-pressed for 5+ seconds, it will enter WiFi configuration mode.
- The M5Atom's LED will turn **blue**, and an access point named `ATOM-SOCKET-XXXX` will start.
- Connect to this access point with a smartphone or PC, and navigate to `192.168.4.1` in a web browser to configure the SSID and password for your WiFi network.
- After configuration, the device will automatically restart.

### 2. Normal Operation
- After connecting to WiFi, a startup notification with the IP address will be sent to LINE.
- A **short press** of the physical button toggles the socket's power.
  - ON: Red LED
  - OFF: Green LED
- Access the device's IP address in a web browser to see the Web UI.

### 3. Web UI Operations
- Power ON/OFF
- Real-time monitoring of power consumption (voltage, current, power)
- Firmware updates via OTA (Over-the-Air)

## OTA Update

1. Access `http://[device_ip_address]/update` in a web browser.
2. Enter the authentication credentials (default: username `admin`, password `admin`).
3. Upload the new firmware (.bin file) generated by the Arduino IDE.

### Note on OTA Updates

- Please select the "Default" partition scheme.

## Troubleshooting

### If OTA Update Fails
1. Ensure the partition scheme is set to "Default".
2. Ensure a stable Wi-Fi connection.

### If LINE Notifications Are Not Received
1. Check if the access token is set correctly.
2. Check the internet connection.
3. Check if you have reached the LINE Messaging API limits.

## License

This project is open source. See the LICENSE file for details.

## References

- [M5Stack Official Website](https://m5stack.com/)
- [LINE Messaging API](https://developers.line.biz/en/services/messaging-api/)
- [Ambient](https://ambidata.io/)
